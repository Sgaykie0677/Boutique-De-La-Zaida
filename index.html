<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique Boss: Dress & Learn!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tone.js CDN for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fce4ec; /* Light pink background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent scrolling */
        }
        .game-container {
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 1200px;
            aspect-ratio: 16 / 9; /* Maintain aspect ratio */
            display: grid; /* Use grid for main layout */
            grid-template-columns: 1fr 2fr; /* Store on left, customer/checkout on right */
            overflow: hidden;
            position: relative;
        }

        /* Game Areas */
        .store-area {
            padding: 20px;
            background-color: #f8bbd0; /* Medium pink */
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Increased gap for items */
            justify-content: center;
            align-content: flex-start;
            border-right: 5px solid #d81b60; /* Darker pink border on right */
            overflow-y: auto; /* Scroll for many items */
            position: relative; /* For the title */
        }
        .store-area-title {
            position: absolute;
            top: 15px;
            width: 100%;
            text-align: center;
        }


        .customer-checkout-area {
            display: flex;
            flex-direction: column;
            background-color: #e0f2f7; /* Light blue */
        }

        .customer-fitting-area {
            flex-grow: 1; /* Takes remaining space */
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Customer at bottom */
            position: relative;
            overflow: hidden;
            padding-bottom: 20px; /* Space above checkout */
        }
        .fitting-area-title {
            position: absolute;
            top: 15px;
            width: 100%;
            text-align: center;
            z-index: 20; /* Ensure title is above customer */
        }

        .checkout-area {
            height: 120px; /* Fixed height for checkout */
            background-color: #c8e6c9; /* Light green for checkout counter */
            border-top: 5px solid #4caf50; /* Green border */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
            position: relative; /* For the title */
        }
        .checkout-area-title {
            position: absolute;
            top: 15px;
            width: 100%;
            text-align: center;
        }

        /* Draggable items */
        .draggable-item {
            width: 90px; /* Slightly larger items */
            height: 90px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: grab;
            user-select: none;
            position: relative;
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
            font-size: 0.9em; /* Adjusted font size */
            text-align: center;
            padding: 5px;
            pointer-events: auto; /* Default */
            border-bottom: 3px solid #ccc; /* Added shelf-like appearance */
        }
        .draggable-item.disabled {
            pointer-events: none; /* Disable dragging */
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(1);
        }
        .draggable-item:active {
            cursor: grabbing;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
            z-index: 100; /* Bring dragged item to front */
        }
        .item-icon {
            font-size: 3em; /* Larger icons */
            margin-bottom: 5px;
        }
        .item-price {
            font-weight: bold;
            color: #d81b60;
        }

        /* Customer */
        .customer {
            position: absolute;
            bottom: -150px; /* Start further off-screen */
            left: 50%;
            transform: translateX(-50%);
            width: 180px; /* Larger customer */
            height: 300px; /* Adjust height for full body */
            background-color: #fce4ec; /* Skin tone */
            border-radius: 50% 50% 0 0 / 60% 60% 0 0; /* Head shape */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: bottom 0.8s ease-out, transform 0.5s ease-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 25px; /* Adjusted padding */
            z-index: 10;
        }

        .customer.active {
            bottom: 0; /* Slide in */
        }

        .customer-body {
            width: 120px; /* Larger body */
            height: 180px;
            background-color: #ffd1dc; /* Light pink for body */
            border-radius: 25px;
            position: absolute;
            bottom: 0;
        }

        .customer-head {
            width: 100px; /* Larger head */
            height: 100px;
            background-color: #fce4ec; /* Skin tone for head */
            border-radius: 50%;
            position: relative;
            top: -25px; /* Position above body */
            z-index: 1;
        }

        .customer-expression {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.5em; /* Larger expression */
        }

        .speech-bubble {
            position: absolute;
            top: -90px; /* Adjusted position */
            right: -100px; /* Adjusted position */
            background-color: #fff;
            border: 2px solid #333;
            border-radius: 15px;
            padding: 10px 15px;
            font-size: 1.2em; /* Slightly larger font */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transform: scale(0); /* Start hidden */
            transform-origin: bottom left;
            animation: pop-in 0.3s forwards ease-out;
            z-index: 20;
            display: flex;
            flex-direction: column; /* Allow multiple lines */
            align-items: flex-start;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #333;
        }
        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #fff;
            z-index: 2;
        }
        .speech-bubble-item-request { /* Renamed for clarity */
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .speech-bubble-item-request:last-child {
            margin-bottom: 0;
        }
        .speech-bubble-item-request .emoji {
            font-size: 1.8em; /* Larger emoji in bubble */
            margin-right: 8px;
        }

        /* Phonics Challenge */
        .phonics-challenge {
            position: absolute;
            bottom: 20px; /* Positioned relative to fitting area */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 25; /* Above customer but below modal */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        .phonics-challenge.active {
            opacity: 1;
            pointer-events: auto;
        }
        .phonics-word-display {
            background-color: #fff;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 2.2em; /* Larger font */
            font-weight: bold;
            color: #d81b60;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .phonics-letters {
            display: flex;
            gap: 12px; /* Increased gap */
        }
        .phonics-letter-button {
            background-color: #d81b60;
            color: white;
            width: 55px; /* Slightly larger buttons */
            height: 55px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em; /* Larger font */
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .phonics-letter-button:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
        }
        .phonics-letter-button:active {
            transform: translateY(0);
        }

        /* NEW: Styles for items directly dressed on the customer */
        .customer-dressed-item {
            position: absolute;
            font-size: 3.5em; /* Default size for dressed item emoji */
            z-index: 12; /* Above customer body, below speech bubble */
            pointer-events: none; /* Not interactive */
            transition: all 0.4s ease-out; /* Smooth placement transition */
            opacity: 0; /* Start hidden for animation */
            animation: fadeInDress 0.5s forwards ease-out; /* Fade in animation */
        }

        @keyframes fadeInDress {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Positioning for each clothing type on the customer */
        .customer-dressed-item.hat {
            top: 50px; /* Adjust based on customer head position */
            left: 50%;
            transform: translateX(-50%);
            font-size: 4em;
        }
        .customer-dressed-item.dress {
            top: 100px; /* Overlap body for full dress */
            left: 50%;
            transform: translateX(-50%);
            font-size: 6em; /* Make dress larger to cover more */
        }
        .customer-dressed-item.shirt {
            top: 120px; /* Overlap upper body */
            left: 50%;
            transform: translateX(-50%);
            font-size: 5em;
        }
        .customer-dressed-item.sweater {
            top: 110px; /* Overlap upper body, slightly higher than shirt */
            left: 50%;
            transform: translateX(-50%);
            font-size: 5.5em;
        }
        .customer-dressed-item.pants {
            top: 180px; /* Overlap lower body */
            left: 50%;
            transform: translateX(-50%);
            font-size: 4.5em;
        }
        .customer-dressed-item.skirt {
            top: 170px; /* Overlap lower body, slightly higher than pants */
            left: 50%;
            transform: translateX(-50%);
            font-size: 5em;
        }
        .customer-dressed-item.shoes {
            bottom: 5px; /* At the bottom of the customer */
            left: 50%;
            transform: translateX(-50%);
            width: 80%; /* To give space for two shoes */
            display: flex; /* Use flex to put two emojis side-by-side */
            justify-content: space-around; /* Distribute shoes */
            font-size: 3em; /* Size of individual shoe emoji */
        }
        /* For shoes and socks, make them appear as two */
        .customer-dressed-item.shoes::before,
        .customer-dressed-item.socks::before {
            content: attr(data-emoji); /* Use data attribute for content */
            font-size: 1em; /* Inherit font size from parent */
        }
        .customer-dressed-item.shoes::after,
        .customer-dressed-item.socks::after {
            content: attr(data-emoji);
            font-size: 1em;
        }
        .customer-dressed-item.socks {
            bottom: 25px; /* Slightly above shoes */
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            display: flex;
            justify-content: space-around;
            font-size: 2.5em;
        }


        /* Cash Register Modal */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .cash-register-modal {
            background-color: #fff;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
            transform: translateY(-50px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            position: relative;
        }
        .modal-overlay.active .cash-register-modal {
            transform: translateY(0);
            opacity: 1;
        }
        .cash-register-modal h2 {
            font-size: 2em;
            color: #d81b60;
            margin-bottom: 20px;
        }
        .register-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.2em;
            color: #333;
        }
        .register-display:last-of-type {
            border-bottom: none;
        }
        .register-display strong {
            color: #d81b60;
        }
        .input-group {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .input-group label {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #555;
        }
        .input-group input {
            width: 150px;
            padding: 10px;
            font-size: 1.5em;
            text-align: center;
            border: 2px solid #f8bbd0;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-group input:focus {
            border-color: #d81b60;
        }
        .modal-buttons {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .modal-button {
            background-color: #d81b60;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .modal-button:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
        }
        .modal-button:active {
            transform: translateY(0);
        }

        /* Game UI */
        .game-ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 30;
        }
        .ui-item {
            font-size: 1.3em;
            font-weight: bold;
            color: #d81b60;
            display: flex;
            align-items: center;
        }
        .ui-item span {
            margin-left: 8px;
            color: #333;
        }

        /* Message Box */
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background-color: #880e4f; /* Darker pink for messages */
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            z-index: 60;
            animation: pop-in 0.4s forwards ease-out;
        }
        .message-box.hidden {
            display: none;
        }

        /* Start Screen */
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffdce5; /* Very light pink */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease-out;
        }
        .start-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .start-screen h1 {
            font-size: 4em;
            color: #d81b60;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        .start-screen button {
            background-color: #d81b60;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.8em;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .start-screen button:hover {
            background-color: #b71c1c;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        .start-screen button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Visual feedback for correct/incorrect */
        .feedback-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 255, 0, 0.2); /* Green overlay for correct */
            border-radius: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
            z-index: 40;
        }

        .feedback-overlay.correct {
            background-color: rgba(0, 200, 0, 0.2);
            opacity: 1;
        }

        .feedback-overlay.incorrect {
            background-color: rgba(255, 0, 0, 0.2);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Start Screen -->
        <div id="start-screen" class="start-screen">
            <h1>Boutique Boss!</h1>
            <p class="text-xl text-gray-700 mb-8">Help your customers find the perfect outfit and practice your math, reading, and phonics!</p>
            <button id="start-button">Start Game</button>
        </div>

        <!-- Game UI (Score, Money) -->
        <div class="game-ui">
            <div class="ui-item">💰 <span id="money-display">0</span></div>
            <div class="ui-item">⭐ <span id="score-display">0</span></div>
        </div>

        <!-- Store Area (Draggable Items) -->
        <div id="store-area" class="store-area">
            <h3 class="text-2xl font-bold text-pink-700 mb-4 store-area-title">The Boutique</h3>
            <!-- Items will be dynamically loaded here by JavaScript -->
        </div>

        <!-- Customer & Checkout Area -->
        <div class="customer-checkout-area">
            <!-- Customer Fitting Area -->
            <div id="customer-fitting-area" class="customer-fitting-area">
                <h3 class="text-2xl font-bold text-blue-700 mb-4 fitting-area-title">Customer Fitting Room</h3>
                <div id="customer" class="customer">
                    <div class="customer-head">
                        <div id="customer-expression" class="customer-expression">😊</div>
                    </div>
                    <div class="customer-body">
                        <!-- Dressed items will be appended here by JS -->
                    </div>
                    <div id="speech-bubble" class="speech-bubble hidden">
                        <div id="speech-text-wrapper"></div>
                    </div>
                </div>
                <!-- Phonics Challenge -->
                <div id="phonics-challenge" class="phonics-challenge">
                    <div id="phonics-word-display" class="phonics-word-display"></div>
                    <div id="phonics-letters" class="phonics-letters"></div>
                </div>
                <!-- Feedback Overlay -->
                <div id="feedback-overlay" class="feedback-overlay rounded-[20px]"></div>
            </div>

            <!-- Checkout Counter Area -->
            <div id="checkout-area" class="checkout-area">
                <h3 class="text-2xl font-bold text-green-700 checkout-area-title">Checkout Counter</h3>
            </div>
        </div>

        <!-- Cash Register Modal -->
        <div id="modal-overlay" class="modal-overlay">
            <div class="cash-register-modal">
                <h2>Cash Register</h2>
                <div class="register-display">
                    <span>Total Cost:</span> <strong>$ <span id="cost-display">0.00</span></strong>
                </div>
                <div id="items-purchased-display" class="text-sm text-gray-600 mt-2 mb-4"></div>
                <div class="input-group">
                    <label for="payment-input">Customer Paid:</label>
                    <input type="number" id="payment-input" placeholder="0">
                </div>
                <div class="register-display mt-4">
                    <span>Change Due:</span> <strong>$ <span id="change-display">0.00</span></strong>
                </div>
                <div class="modal-buttons">
                    <button id="confirm-payment-button" class="modal-button">Confirm</button>
                    <button id="cancel-payment-button" class="modal-button bg-gray-500 hover:bg-gray-700">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="message-box hidden"></div>
    </div>

    <script>
        // Game State Variables
        let currentMoney = 100; // Starting money
        let score = 0;
        let currentCustomer = null;
        let requestedItems = []; // Array of items the current customer wants
        let customerCart = []; // Items successfully dragged to the customer
        let currentDraggedItem = null;
        let initialMouseX;
        let initialMouseY;
        let initialItemX;
        let initialItemY;
        let isPhonicsActive = false;
        let phonicsWord = '';
        let hiddenPhonicsLetter = '';
        let hiddenPhonicsIndex = -1;

        // Tone.js Synths for sound effects
        let correctSynth = new Tone.Synth().toDestination();
        let incorrectSynth = new Tone.Synth().toDestination();
        let coinSynth = new Tone.Synth().toDestination();
        let happyCustomerSynth = new Tone.Synth().toDestination();
        let unhappyCustomerSynth = new Tone.Synth().toDestination();

        // HTML Elements
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const storeArea = document.getElementById('store-area');
        const customerFittingArea = document.getElementById('customer-fitting-area'); // Corrected variable name
        const customerEl = document.getElementById('customer');
        const customerExpressionEl = document.getElementById('customer-expression');
        const speechBubble = document.getElementById('speech-bubble');
        const speechTextWrapper = document.getElementById('speech-text-wrapper');
        const modalOverlay = document.getElementById('modal-overlay');
        const costDisplay = document.getElementById('cost-display');
        const itemsPurchasedDisplay = document.getElementById('items-purchased-display');
        const paymentInput = document.getElementById('payment-input');
        const changeDisplay = document.getElementById('change-display');
        const confirmPaymentButton = document.getElementById('confirm-payment-button');
        const cancelPaymentButton = document.getElementById('cancel-payment-button');
        const moneyDisplay = document.getElementById('money-display');
        const scoreDisplay = document.getElementById('score-display');
        const messageBox = document.getElementById('message-box');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const phonicsChallenge = document.getElementById('phonics-challenge');
        const phonicsWordDisplay = document.getElementById('phonics-word-display');
        const phonicsLettersContainer = document.getElementById('phonics-letters');
        const checkoutArea = document.getElementById('checkout-area');

        // Game Data (Items, Customers)
        const items = [
            { id: 'dress', name: 'Dress', price: 15, emoji: '👗' },
            { id: 'shirt', name: 'Shirt', price: 10, emoji: '👕' },
            { id: 'pants', name: 'Pants', price: 12, emoji: '👖' },
            { id: 'shoes', name: 'Shoes', price: 8, emoji: '👟' },
            { id: 'hat', name: 'Hat', price: 7, emoji: '🎩' },
            { id: 'skirt', name: 'Skirt', price: 11, emoji: '🩱' }, /* Using swimsuit as skirt icon */
            { id: 'sweater', name: 'Sweater', price: 18, emoji: '🧶' },
            { id: 'socks', name: 'Socks', price: 5, emoji: '🧦' }
        ];

        const customers = [
            { name: 'Alice', requests: ['dress', 'shoes'], expression: '😀', color: '#ffb3ba' },
            { name: 'Bob', requests: ['shirt', 'pants', 'hat'], expression: '😊', color: '#bae1ff' },
            { name: 'Charlie', requests: ['sweater', 'socks'], expression: '😇', color: '#baffc9' },
            { name: 'Diana', requests: ['skirt', 'shirt'], expression: '😁', color: '#ffdfba' },
            { name: 'Eve', requests: ['dress', 'hat', 'socks'], expression: '🙂', color: '#c9baff' }
        ];

        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Game Initialization ---
        function initGame() {
            console.log('initGame: Initializing game.');
            renderStoreItems();
            updateUI();
            startButton.addEventListener('click', startGame);

            // Set up Tone.js sounds
            correctSynth.oscillator.type = "sine";
            incorrectSynth.oscillator.type = "sawtooth";
            coinSynth.oscillator.type = "triangle";
            happyCustomerSynth.oscillator.type = "square";
            unhappyCustomerSynth.oscillator.type = "triangle";
        }

        async function startGame() {
            console.log('startGame: Starting game.');
            // Start Tone.js audio context on user interaction
            await Tone.start();
            console.log("startGame: Audio context started.");

            startScreen.classList.add('hidden');
            setTimeout(spawnNewCustomer, 500); // Small delay before first customer
        }

        // --- UI Updates ---
        function updateUI() {
            moneyDisplay.textContent = currentMoney.toFixed(2);
            scoreDisplay.textContent = score;
        }

        function showMessage(message, duration = 2000) {
            console.log('showMessage:', message);
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }

        function showFeedbackOverlay(type) {
            console.log('showFeedbackOverlay:', type);
            feedbackOverlay.classList.remove('correct', 'incorrect');
            feedbackOverlay.classList.add(type);
            feedbackOverlay.style.opacity = 1;
            setTimeout(() => {
                feedbackOverlay.style.opacity = 0;
            }, 500);
        }

        // --- Item Rendering & Drag/Drop Logic ---
        function renderStoreItems() {
            console.log('renderStoreItems: Rendering store items.');
            storeArea.innerHTML = '<h3 class="text-2xl font-bold text-pink-700 mb-4 store-area-title">The Boutique</h3>'; // Clear previous items and add title
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.classList.add('draggable-item');
                itemEl.setAttribute('data-id', item.id);
                itemEl.innerHTML = `
                    <span class="item-icon">${item.emoji}</span>
                    <span class="item-name">${item.name}</span>
                    <span class="item-price">$${item.price.toFixed(2)}</span>
                `;
                itemEl.addEventListener('mousedown', startDrag);
                storeArea.appendChild(itemEl);
            });
            disableAllDraggableItems(); // Initially disable dragging until phonics is solved or customer requests appear
        }

        function enableAllDraggableItems() {
            console.log('enableAllDraggableItems: Enabling all draggable items.');
            document.querySelectorAll('.draggable-item').forEach(itemEl => {
                itemEl.classList.remove('disabled');
            });
        }

        function disableAllDraggableItems() {
            console.log('disableAllDraggableItems: Disabling all draggable items.');
            document.querySelectorAll('.draggable-item').forEach(itemEl => {
                itemEl.classList.add('disabled');
            });
        }

        function startDrag(e) {
            console.log('startDrag: Drag started.');
            if (e.button !== 0 || currentDraggedItem || isPhonicsActive) return; // Only allow left-click, one item at a time, and not during phonics
            if (e.target.closest('.draggable-item').classList.contains('disabled')) {
                console.log('startDrag: Item is disabled, preventing drag.');
                return; // Don't drag if disabled
            }

            currentDraggedItem = e.target.closest('.draggable-item');
            if (!currentDraggedItem) return;

            // Get initial mouse position
            initialMouseX = e.clientX;
            initialMouseY = e.clientY;

            // Get initial item position relative to the viewport
            const rect = currentDraggedItem.getBoundingClientRect();
            initialItemX = rect.left;
            initialItemY = rect.top;

            // Make the item absolutely positioned for dragging (relative to viewport)
            currentDraggedItem.style.position = 'fixed'; // Use fixed to drag over other elements
            currentDraggedItem.style.left = initialItemX + 'px';
            currentDraggedItem.style.top = initialItemY + 'px';
            currentDraggedItem.style.zIndex = '1000'; // Bring to front

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function drag(e) {
            if (!currentDraggedItem) return;

            // Calculate new position relative to initial mouse down
            const dx = e.clientX - initialMouseX;
            const dy = e.clientY - initialMouseY;

            currentDraggedItem.style.left = (initialItemX + dx) + 'px';
            currentDraggedItem.style.top = (initialItemY + dy) + 'px';
        }

        function stopDrag(e) {
            console.log('stopDrag: Drag stopped.');
            if (!currentDraggedItem) return;

            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);

            const customerBodyRect = customerEl.querySelector('.customer-body').getBoundingClientRect();
            const itemRect = currentDraggedItem.getBoundingClientRect();

            // Check if item is dropped on the customer's body area
            if (itemRect.left < customerBodyRect.right &&
                itemRect.right > customerBodyRect.left &&
                itemRect.top < customerBodyRect.bottom &&
                itemRect.bottom > customerBodyRect.top) {
                handleDrop(currentDraggedItem);
            } else {
                console.log('stopDrag: Item not dropped on customer, returning to store.');
                // If not dropped on customer, return to original position in store
                resetItemPosition(currentDraggedItem);
            }

            currentDraggedItem = null;
        }

        function resetItemPosition(itemEl) {
            console.log('resetItemPosition: Resetting item position.');
            // Find the original item element in the store area and reset its style
            const originalItemInStore = storeArea.querySelector(`[data-id="${itemEl.getAttribute('data-id')}"]`);
            if (originalItemInStore) {
                originalItemInStore.style.position = 'relative';
                originalItemInStore.style.left = '0px';
                originalItemInStore.style.top = '0px';
                originalItemInStore.style.zIndex = 'auto';
            }
             if (itemEl.style.position === 'fixed') { 
                itemEl.style.position = 'relative';
                itemEl.style.left = '0px';
                itemEl.style.top = '0px';
                itemEl.style.zIndex = 'auto';
            }
        }

        function handleDrop(droppedItemEl) {
            const itemId = droppedItemEl.getAttribute('data-id');
            const selectedItem = items.find(item => item.id === itemId);
            console.log('handleDrop: Dropped item:', selectedItem.name, 'Requested items:', requestedItems.map(i => i.name));

            if (!selectedItem || !requestedItems.length) {
                console.error('handleDrop: No selected item or no requested items.');
                showMessage('Something went wrong. Try again!');
                resetItemPosition(droppedItemEl);
                return;
            }

            // Check if the dropped item is one of the currently requested items AND not already in the cart
            const isRequested = requestedItems.some(req => req.id === selectedItem.id);
            const isInCart = customerCart.some(cartItem => cartItem.id === selectedItem.id);

            if (isRequested && !isInCart) {
                console.log('handleDrop: Correct item dropped.');
                // Correct item! Move it to the customer's cart.
                customerCart.push(selectedItem);
                
                // Remove the original item from the store (or visually hide it)
                const storeItem = storeArea.querySelector(`[data-id="${selectedItem.id}"]`);
                if (storeItem) {
                    storeItem.style.opacity = '0'; // Visually hide it
                    storeItem.style.pointerEvents = 'none'; // Make it unclickable
                    storeItem.classList.add('disabled'); // Add disabled class
                }

                // NEW: Create and position the dressed item on the customer
                const dressedItemEl = document.createElement('div');
                dressedItemEl.classList.add('customer-dressed-item', selectedItem.id); // Add item ID as class for specific styling
                dressedItemEl.setAttribute('data-emoji', selectedItem.emoji); // Store emoji for pseudo-elements if needed for shoes/socks
                dressedItemEl.textContent = selectedItem.emoji; // Display the emoji
                customerEl.appendChild(dressedItemEl); // Append directly to the customer element

                showMessage(`Got the ${selectedItem.name}!`, 1000);
                showFeedbackOverlay('correct');
                correctSynth.triggerAttackRelease("C5", "8n"); // Play correct sound
                customerExpressionEl.textContent = '🙂'; // Slightly happy

                updateCustomerRequestDisplay();

                if (customerCart.length === requestedItems.length) {
                    console.log('handleDrop: All items collected.');
                    // All items collected, proceed to cash register
                    setTimeout(() => {
                        showMessage('All items collected! Time to pay!', 1500);
                        customerExpressionEl.textContent = '😀';
                        happyCustomerSynth.triggerAttackRelease("G4", "8n"); // Happy sound
                        openCashRegister();
                    }, 1200);
                }
            } else if (isInCart) {
                console.log('handleDrop: Item already in cart.');
                showMessage(`You already have the ${selectedItem.name}!`, 1500);
                showFeedbackOverlay('incorrect');
                incorrectSynth.triggerAttackRelease("C3", "8n"); // Play incorrect sound
                customerExpressionEl.textContent = '🤔'; // Confused
                resetItemPosition(droppedItemEl); // Return to store
            }
            else {
                console.log('handleDrop: Incorrect item dropped.');
                // Incorrect item
                showMessage(`I don't need a ${selectedItem.name} right now.`, 2000);
                customerExpressionEl.textContent = '😞'; // Sad face
                showFeedbackOverlay('incorrect');
                incorrectSynth.triggerAttackRelease("C3", "8n"); // Play incorrect sound
                setTimeout(() => {
                    customerExpressionEl.textContent = currentCustomer.expression; // Reset expression
                }, 1000);
                resetItemPosition(droppedItemEl); // Return to store
            }
        }

        // --- Customer Logic ---
        function spawnNewCustomer() {
            console.log('spawnNewCustomer: Spawning new customer.');
            // Reset for new customer
            customerCart = [];
            
            // Remove all dynamically added dressed items from the previous customer
            const dressedItems = customerEl.querySelectorAll('.customer-dressed-item');
            dressedItems.forEach(item => item.remove());
            console.log('spawnNewCustomer: Cleared previous customer outfit.');

            enableAllDraggableItems(); // Ensure all store items are available

            // Pick a random customer
            currentCustomer = customers[Math.floor(Math.random() * customers.length)];
            customerEl.style.backgroundColor = currentCustomer.color;
            customerExpressionEl.textContent = currentCustomer.expression;
            console.log('spawnNewCustomer: Selected customer:', currentCustomer.name);
            
            // Randomly select 1 to 3 items for the customer to request
            requestedItems = shuffleArray([...currentCustomer.requests]).slice(0, Math.floor(Math.random() * 3) + 1);
            requestedItems = requestedItems.map(id => items.find(item => item.id === id)); // Get full item objects
            console.log('spawnNewCustomer: Customer requests:', requestedItems.map(item => item.name));

            // Animate customer entry
            customerEl.classList.add('active');
            setTimeout(() => {
                // Decide if this customer gets a phonics challenge
                const applyPhonics = Math.random() < 0.7; // 70% chance for phonics
                if (applyPhonics && requestedItems.length === 1) { // Only apply to single item requests for simplicity
                    console.log('spawnNewCustomer: Setting up phonics challenge.');
                    setupPhonicsChallenge(requestedItems[0]);
                } else {
                    console.log('spawnNewCustomer: No phonics, updating request display and enabling drag.');
                    updateCustomerRequestDisplay();
                    enableAllDraggableItems(); // Enable dragging if no phonics
                }
            }, 800); // Delay speech bubble until customer is in place
        }

        function updateCustomerRequestDisplay() {
            console.log('updateCustomerRequestDisplay: Updating speech bubble content.');
            speechTextWrapper.innerHTML = '';
            const remainingRequests = requestedItems.filter(reqItem => !customerCart.some(cartItem => cartItem.id === reqItem.id));

            if (remainingRequests.length === 0) {
                console.log('updateCustomerRequestDisplay: All requests fulfilled, hiding bubble.');
                hideSpeechBubble();
                return;
            }

            remainingRequests.forEach((item, index) => {
                const itemSpan = document.createElement('span');
                itemSpan.classList.add('speech-bubble-item-request');
                itemSpan.innerHTML = `<span class="emoji">${item.emoji}</span>${item.name}`;
                speechTextWrapper.appendChild(itemSpan);
            });
            showSpeechBubble();
        }

        function showSpeechBubble() {
            console.log('showSpeechBubble: Showing speech bubble.');
            speechBubble.classList.remove('hidden');
        }

        function hideSpeechBubble() {
            console.log('hideSpeechBubble: Hiding speech bubble.');
            speechBubble.classList.add('hidden');
        }

        function customerLeaves() {
            console.log('customerLeaves: Customer leaving.');
            customerEl.classList.remove('active');
            hideSpeechBubble();
            // Reset opacities of store items that were hidden
            document.querySelectorAll('.draggable-item').forEach(itemEl => {
                itemEl.style.opacity = '1';
                itemEl.style.pointerEvents = 'auto';
                itemEl.classList.remove('disabled');
            });

            // Remove all dynamically added dressed items for the leaving customer
            const dressedItems = customerEl.querySelectorAll('.customer-dressed-item');
            dressedItems.forEach(item => item.remove());

            setTimeout(() => {
                customerExpressionEl.textContent = '😊'; // Reset to default happy
                spawnNewCustomer();
            }, 1000); // Wait for customer to slide out
        }

        // --- Phonics Logic ---
        function setupPhonicsChallenge(item) {
            console.log('setupPhonicsChallenge: Initializing for item:', item.name);
            isPhonicsActive = true;
            disableAllDraggableItems(); // Disable dragging during phonics
            
            phonicsWord = item.name.toUpperCase();
            let possibleIndices = [];
            for (let i = 0; i < phonicsWord.length; i++) {
                if (phonicsWord[i].match(/[A-Z]/)) {
                    possibleIndices.push(i);
                }
            }
            if (possibleIndices.length > 0) {
                 hiddenPhonicsIndex = possibleIndices[Math.floor(Math.random() * possibleIndices.length)];
            } else {
                hiddenPhonicsIndex = 0;
            }
            console.log('Phonics word:', phonicsWord, 'Hidden index:', hiddenPhonicsIndex);

            hiddenPhonicsLetter = phonicsWord[hiddenPhonicsIndex];
            
            let displayWord = phonicsWord.split('');
            displayWord[hiddenPhonicsIndex] = '_';
            phonicsWordDisplay.textContent = displayWord.join('');

            // Generate letter options
            phonicsLettersContainer.innerHTML = '';
            let options = [hiddenPhonicsLetter];
            while (options.length < 4) {
                const randomChar = String.fromCharCode(65 + Math.floor(Math.random() * 26));
                if (!options.includes(randomChar) && randomChar !== hiddenPhonicsLetter) {
                    options.push(randomChar);
                }
            }
            shuffleArray(options);

            options.forEach(letter => {
                const button = document.createElement('button');
                button.classList.add('phonics-letter-button');
                button.textContent = letter;
                button.addEventListener('click', () => checkPhonicsLetter(letter, item.name));
                phonicsLettersContainer.appendChild(button);
            });

            phonicsChallenge.classList.add('active');
            updateCustomerRequestDisplay();
        }

        function checkPhonicsLetter(selectedLetter, originalItemName) {
            console.log('checkPhonicsLetter: Selected:', selectedLetter, 'Correct:', hiddenPhonicsLetter);
            if (selectedLetter === hiddenPhonicsLetter) {
                showMessage('Correct!', 1000);
                correctSynth.triggerAttackRelease("E5", "8n");
                phonicsWordDisplay.textContent = originalItemName.toUpperCase();
                phonicsChallenge.classList.remove('active');
                isPhonicsActive = false;
                enableAllDraggableItems();
                customerExpressionEl.textContent = currentCustomer.expression;

                updateCustomerRequestDisplay();

            } else {
                showMessage('Oops! Try again.', 1000);
                showFeedbackOverlay('incorrect');
                incorrectSynth.triggerAttackRelease("C4", "8n");
                customerExpressionEl.textContent = '😥';
                setTimeout(() => {
                    customerExpressionEl.textContent = currentCustomer.expression;
                }, 500);
            }
        }

        // --- Cash Register Logic ---
        function openCashRegister() {
            console.log('openCashRegister: Opening cash register.');
            let totalCost = customerCart.reduce((sum, item) => sum + item.price, 0);
            costDisplay.textContent = totalCost.toFixed(2);
            
            itemsPurchasedDisplay.innerHTML = 'Items: ' + customerCart.map(item => item.name).join(', ');

            paymentInput.value = '';
            changeDisplay.textContent = '0.00';
            modalOverlay.classList.add('active');
            paymentInput.focus();
        }

        paymentInput.addEventListener('input', () => {
            const cost = parseFloat(costDisplay.textContent);
            const paid = parseFloat(paymentInput.value);
            if (!isNaN(paid)) {
                const change = paid - cost;
                changeDisplay.textContent = Math.max(0, change).toFixed(2);
            } else {
                changeDisplay.textContent = '0.00';
            }
        });

        confirmPaymentButton.addEventListener('click', () => {
            console.log('Confirm payment button clicked.');
            const cost = parseFloat(costDisplay.textContent);
            const paid = parseFloat(paymentInput.value);

            if (isNaN(paid) || paid < cost) {
                showMessage('Not enough money! Please try again.', 2000);
                showFeedbackOverlay('incorrect');
                incorrectSynth.triggerAttackRelease("C3", "8n");
                paymentInput.focus();
                return;
            }

            const change = paid - cost;
            const displayedChange = parseFloat(changeDisplay.textContent);

            if (Math.abs(change - displayedChange) < 0.01) {
                console.log('Payment correct. Processing transaction.');
                currentMoney += cost;
                score += requestedItems.length;
                updateUI();
                showMessage(`Great job! Your change is $${change.toFixed(2)}`, 2000);
                coinSynth.triggerAttackRelease("F5", "8n");
                customerExpressionEl.textContent = '�';
                modalOverlay.classList.remove('active');
                setTimeout(customerLeaves, 2500);
            } else {
                console.log('Payment incorrect. Try again.');
                showMessage('Hmm, that change isn\'t quite right. Try again!', 2000);
                showFeedbackOverlay('incorrect');
                incorrectSynth.triggerAttackRelease("C3", "8n");
                paymentInput.focus();
            }
        });

        cancelPaymentButton.addEventListener('click', () => {
            console.log('Cancel payment button clicked.');
            modalOverlay.classList.remove('active');
            showMessage('Transaction cancelled. Customer left unhappy.', 2500);
            customerExpressionEl.textContent = '😞';
            showFeedbackOverlay('incorrect');
            unhappyCustomerSynth.triggerAttackRelease("C3", "8n");
            setTimeout(customerLeaves, 2500);
        });

        // Initialize game on window load
        window.onload = initGame;
    </script>
</body>
</html>
�
